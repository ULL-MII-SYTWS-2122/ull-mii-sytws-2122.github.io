<!doctype html>
<html lang=" en-US ">

<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=0c17a04726783310cf310dd26efc2c11d95d3ed3">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="/assets/js/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="/assets/css/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

</head>

<body>
    <div id="header">
        <nav>
  <ul>
    <li><a href="/search" title="search">&#x1F50D;</a></li>
    <!--
    <li><a href="#sytwstoc" title="Table of Contents">‚â°</a></li>
    -->

      
    <li><a href="/practicas/event-emitters" title="Previous">&#x2190;</a></li>
    
    
    <li><a href="/practicas/async-await-is-generators-and-promises/solution" title="Next">&#x2192;</a></li>
    
    <li><a href="https://github.com/ULL-MII-SYTWS/ull-mii-sytws.github.io-source/tree/main//_practicas/26-robust-microservices.md" title="Edit this page at GitHub">üêô</a>
    <li><a href="/references.html" title="Bibliograf√≠a">&#x1f4da</a></li>
    <li><a href="/practicas.html" title="Pr√°cticas">&#x270d</a></li>
    <li><a href="/clases.html" title="Clases">üë®‚Äçüè´</a></li>
    <li><a href="/" title="Home page">&#x1f3e0</a></li>
    <li><a href="/tema0-presentacion/" title="Tema 0: Presentaci√≥n">0</a></li>
    <li><a href="/tema1-introduccion/" title="Tema 1: Introducci√≥n">1</a></li>
    <li><a href="/tema2-async/" title="Tema 2: Async">2</a></li>
    <li><a href="/tema3-web/" title="Tema 3: Web">3</a></li>
    <li><a href="/tema4-devops/" title="Tema 4: Devop">4</a></li>
    
    </li>
    </ul>
</nav>

    </div>
    <!-- end header -->


    <div class="wrapper">

        <section>
            
<div id="title">
        <h1>Sistemas y Tecnolog√≠as Web: Servidor</h1>
        <p> Master de II. ULL. 1er cuatrimestre</p>
        <hr>
        <span class="credits left">Organization <a href="https://github.com/ULL-MII-SYTWS-2122" target="_blank">ULL-MII-SYTWS-2122</a></span>
        <span class="credits left"> &nbsp; Classroom <a href="https://classroom.github.com/classrooms/90842007-ull-mii-sytws-2122" target="_blank">ULL-MII-SYTWS-2122</a></span>
        <span class="credits left"> &nbsp; Campus Virtual <a href="https://campusdoctoradoyposgrado2122.ull.es/course/view.php?id=2122110810" target="_blank">SYTWS</a></span>
        <span class="credits left"> &nbsp; Chat <a href="https://chat.google.com/u/1/room/AAAAp18fCE8" target="_blank">Chat</a></span>
        <span class="credits left"> &nbsp; Profesor <a href="https://www.ull.es/apps/guias/guias/view_teacher_niu/837/crguezl/" target="_blank">Casiano</a></span>
    </div>

<!--

<div id="title">
    <h1>Sistemas y Tecnolog√≠as Web: Servidor</h1>
    <p> Master de II. ULL. 1er cuatrimestre</p>
    <hr>
    <span class="credits left">Organization <a href="https://github.com/ULL-MII-SYTWS"
            target="_blank">ULL-MII-SYTWS</a></span>
    <span class="credits left"> &nbsp; Github Classroom <a
            href="https://classroom.github.com/classrooms/55384072-master-de-ingenieria-informatica-sistemas-y-tecnologias-web-servidor-classroom"
            target="_blank">SYTWS 19/20</a></span>
    <span class="credits left"> &nbsp; Campus Virtual <a
            href="https://campusvirtual.ull.es/1920/course/view.php?id=201913778" target="_blank">SYTWS
            19/20</a></span>
    <span class="credits left"> &nbsp; Profesor <a
            href="https://www.ull.es/apps/guias/guias/view_teacher_niu/588/(%3FPcrguezl.*)/"" target="
            _blank">Casiano</a></span>
</div>
-->    

            
            



            

            <div class="container"> 
                <h1> Robust Microservices </h1>
                
<ul>
  <li>
    <p>Lea el <a href="https://github.com/ULL-MII-SYTWS-2122/books-shared">Cap√≠tulo 4 ‚ÄúConnecting Robust Microservices‚Äù de <em>Node.JS The Right Way</em></a>  y resuelva los problemas en la secciones</p>
  </li>
  <li><em>Error Handling</em>,</li>
  <li><em>Robustness</em><code class="language-plaintext highlighter-rouge"> </code> y</li>
  <li><em>Bidirectional Messaging</em>:</li>
</ul>

<h2 id="error-handling">Error Handling</h2>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">zmq-filer-rep.js</code> program uses <code class="language-plaintext highlighter-rouge">fs.readfile()</code> to serve up file contents. However it doesn‚Äôt handle error cases.
    <ul>
      <li>What should the program do in the case of error?</li>
      <li>How would you change the JSON object structure of messages to support  sending an error to the requester?</li>
    </ul>
  </li>
  <li>Later in the same program we listen for the Unix signal <code class="language-plaintext highlighter-rouge">SIGINT</code> to detect the user‚Äôs <code class="language-plaintext highlighter-rouge">Ctrl-C</code> in the terminal
    <ul>
      <li>What happens if the program ends in some other way , like <code class="language-plaintext highlighter-rouge">SIGTERM</code> (the termination signal)?</li>
      <li>What happens if there is an unhandled Node.js exception, and how should we deal with it?
        <ul>
          <li><em>Hint</em>: you can listen for the <code class="language-plaintext highlighter-rouge">uncaughtException</code> event on the process object</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="robustness">Robustness</h2>

<ul>
  <li>In <em>Building a Cluster</em> we created a Node.js cluster that spins up a pool of worker processes.</li>
  <li>In the master process we listened for <code class="language-plaintext highlighter-rouge">online</code> events and logged a message when the workers came up.</li>
  <li>But we didn‚Äôt specify what should happen when a worker ends.
    <ul>
      <li>What happens when you kill a worker process from the command line?
        <ul>
          <li><em>Hint</em>: Use <code class="language-plaintext highlighter-rouge">kill [pid]</code>from the command line</li>
        </ul>
      </li>
      <li>How would you change the <code class="language-plaintext highlighter-rouge">zmq-filer-rep-cluster.js</code> program to fork a new worker whenever one dies?</li>
    </ul>
  </li>
</ul>

<h2 id="bidirectional-messaging">Bidirectional Messaging</h2>

<ul>
  <li>For this project you‚Äôll need to use 0MQ PUSH/PULL sockets and the Node.js clustering techniques.</li>
  <li>Your clustered program will spin up a pool of workers and distribute 30 jobs.</li>
  <li>The master process should:
    <ul>
      <li>Create a <code class="language-plaintext highlighter-rouge">PUSH</code> socket and bind it to an IPC endpoint. This socket will be for sending jobs to the workers</li>
      <li>Create a <code class="language-plaintext highlighter-rouge">PULL</code> socket and bind it to a different IPC endpoint. This socket will receive messages from the workers</li>
      <li>Keep a count of ready workers</li>
      <li>Listen for messages on the PULL socket, and
        <ul>
          <li>If the message is a <code class="language-plaintext highlighter-rouge">ready</code> message, increment the ready counter, or</li>
          <li>If the message is a <code class="language-plaintext highlighter-rouge">result</code> message , output it to the console</li>
        </ul>
      </li>
      <li>Spin up the worker processes</li>
      <li>When the ready counter reaches 3 send 30 <code class="language-plaintext highlighter-rouge">job</code> messages out through the push socket</li>
    </ul>
  </li>
  <li>The worker process should:
    <ul>
      <li>Create a <code class="language-plaintext highlighter-rouge">PULL</code> socket and connect it to the master ‚Äòs <code class="language-plaintext highlighter-rouge">PUSH</code> endpoint</li>
      <li>Create a <code class="language-plaintext highlighter-rouge">PUSH</code> socket and connect it to the master ‚Äòs <code class="language-plaintext highlighter-rouge">PULL</code> endpoint</li>
      <li>Listen for <code class="language-plaintext highlighter-rouge">job</code> messages on the <code class="language-plaintext highlighter-rouge">PULL</code> socket, and respond by sending a <code class="language-plaintext highlighter-rouge">result</code> message out on the <code class="language-plaintext highlighter-rouge">PUSH</code> socket</li>
      <li>Send a <code class="language-plaintext highlighter-rouge">ready</code> message out on the <code class="language-plaintext highlighter-rouge">PUSH</code> socket.</li>
    </ul>
  </li>
  <li>Make sure your <code class="language-plaintext highlighter-rouge">result</code>  messages include at least the process ID of the worker. 
This way you can inspect the console output and confirm that the workload is being <em>balanced</em> among the worker processes.</li>
  <li>See <a href="https://github.com/ULL-MII-CA-1819/nodejs-the-right-way/tree/master/connecting-robust-microservices-chapter-4/microservices/ventilator-worker-sink">the example in directory ventilator-worker-sink</a></li>
  <li>See section PUSH-PULL in file <a href="https://github.com/ULL-MII-CA-1819/nodejs-the-right-way/blob/master/connecting-robust-microservices-chapter-4/microservices/README.md">Readme.md</a> in the folder <code class="language-plaintext highlighter-rouge">connecting-robust-microservices-chapter-4/microservices</code> in our repo <code class="language-plaintext highlighter-rouge">ULL-MII-CA-1819/nodejs-the-right-way</code></li>
</ul>

<h2 id="reto-1-granja-de-trabajadores">Reto 1: Granja de Trabajadores</h2>

<p>En el paradigma de paralelismo conocido como <em>Farm</em> o <em>Granja de
Procesadores</em> la tarea que se quiere realizar es dividida en un subconjunto de sub-tareas 
bastante mayor que el n√∫mero de procesadores disponibles.</p>
<ol>
  <li>Un procesador denominado maestro o capataz envia las
tareas a los restantes procesos-trabajadores.</li>
  <li>Tan pronto como un trabajador devuelve el resultado de una subtarea el capataz le env√≠a una
nueva subtarea.</li>
  <li>El capataz combina el resultado parcial con los que
haya obtenido hasta ese momento para ir cosntruyendo la soluci√≥n a la tarea inicial.</li>
</ol>

<p>Una ventaja que tiene este paradigma es que consigue equilibrar la carga de trabajo entre las m√°quinas,</p>
<ul>
  <li>independientemente de que estas sean heterog√©neas o no,</li>
  <li>independientemente de cual sea la carga din√°mica de las estaciones por la presencia
de otros procesos y usuarios e</li>
  <li>independientemente de que las tareas sean heterog√©neas en sus necesidades de tiempo de c√≥mputo.</li>
</ul>

<p>En el siguiente c√≥digo mostramos como usar los sockets ROUTER  y DEALER de 0MQ junto 
con los clusters de Node.js para  crear un borrador de una granja de trabajadores:</p>

<p><strong>Fichero connecting-robust-microservices-chapter-4/microservices/dealer.js</strong></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="codehilite"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre></td><td class="rouge-code"><pre><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./port.js</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">ins</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./ins.js</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cluster</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">cluster</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">zmq</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">zeromq</span><span class="dl">"</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">numWorkers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">os</span><span class="dl">"</span><span class="p">).</span><span class="nx">cpus</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">randomBetween</span> <span class="o">=</span> <span class="p">(</span><span class="nx">min</span><span class="p">,</span> <span class="nx">max</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">max</span> <span class="o">-</span> <span class="nx">min</span><span class="p">)</span> <span class="o">+</span> <span class="nx">min</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">workerTask</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">dealer</span> <span class="o">=</span> <span class="nx">zmq</span><span class="p">.</span><span class="nx">socket</span><span class="p">(</span><span class="dl">'</span><span class="s1">dealer</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">dealer</span><span class="p">.</span><span class="nx">identity</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="dl">"</span><span class="s2">identity</span><span class="dl">"</span><span class="p">];</span> 

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">identity </span><span class="dl">"</span><span class="o">+</span><span class="nx">dealer</span><span class="p">.</span><span class="nx">identity</span><span class="o">+</span>
              <span class="dl">"</span><span class="s2"> process </span><span class="dl">"</span><span class="o">+</span><span class="nx">process</span><span class="p">.</span><span class="nx">pid</span><span class="o">+</span><span class="dl">"</span><span class="s2"> port = </span><span class="dl">"</span><span class="o">+</span><span class="nx">PORT</span><span class="p">);</span>

  <span class="nx">dealer</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="dl">'</span><span class="s1">tcp://localhost:</span><span class="dl">'</span><span class="o">+</span><span class="nx">PORT</span><span class="p">);</span>

  <span class="kd">let</span> <span class="nx">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">sendMessage</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">dealer</span><span class="p">.</span><span class="nx">send</span><span class="p">([</span><span class="dl">'</span><span class="s1">ready</span><span class="dl">'</span><span class="p">]);</span>

  <span class="c1">//  Get workload from broker, until finished</span>
  <span class="nx">dealer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">onMessage</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// console.log("Inside Worker. args = "+ins(args.map(x =&gt; x.toString())));</span>
    <span class="kd">const</span> <span class="nx">workload</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">utf8</span><span class="dl">'</span><span class="p">);</span>
    <span class="c1">//console.log("Inside Worker. workload = "+workload);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">workload</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">stop</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Completed: </span><span class="dl">'</span><span class="o">+</span><span class="nx">total</span><span class="o">+</span><span class="dl">'</span><span class="s1"> tasks (</span><span class="dl">'</span><span class="o">+</span><span class="nx">dealer</span><span class="p">.</span><span class="nx">identity</span><span class="o">+</span><span class="dl">'</span><span class="s1"> </span><span class="dl">'</span><span class="o">+</span><span class="nx">process</span><span class="p">.</span><span class="nx">pid</span><span class="o">+</span><span class="dl">'</span><span class="s1">)</span><span class="dl">'</span><span class="p">);</span>
      <span class="nx">dealer</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="nx">onMessage</span><span class="p">);</span>
      <span class="c1">// https://nodejs.org/api/events.html#events_emitter_removelistener_eventname_listener is a method of EventsEmitter</span>
      <span class="nx">dealer</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">total</span><span class="o">++</span><span class="p">;</span>

    <span class="c1">// Simulate some work</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">sendMessage</span><span class="p">,</span> <span class="nx">randomBetween</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">));</span>
  <span class="p">});</span>

  <span class="c1">//  Tell the broker we're ready for work</span>
  <span class="nx">sendMessage</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">broker</span> <span class="o">=</span> <span class="nx">zmq</span><span class="p">.</span><span class="nx">socket</span><span class="p">(</span><span class="dl">'</span><span class="s1">router</span><span class="dl">'</span><span class="p">);</span>
  <span class="c1">//broker.bindSync('tcp://*:5671');</span>
  <span class="nx">broker</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="dl">'</span><span class="s1">tcp://*:</span><span class="dl">'</span><span class="o">+</span><span class="nx">PORT</span><span class="p">);</span>

  <span class="kd">let</span> <span class="nx">endTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">+</span> <span class="mi">5000</span>
    <span class="p">,</span> <span class="nx">workersFired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="nx">broker</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// console.log("Inside Master. args = "+ins(args.map(x =&gt; x.toString())));</span>
    <span class="kd">const</span> <span class="nx">identity</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="p">,</span> <span class="nx">now</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">now</span> <span class="o">&lt;</span> <span class="nx">endTime</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">broker</span><span class="p">.</span><span class="nx">send</span><span class="p">([</span><span class="nx">identity</span><span class="p">,</span> <span class="dl">'</span><span class="s1">more work</span><span class="dl">'</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">broker</span><span class="p">.</span><span class="nx">send</span><span class="p">([</span><span class="nx">identity</span><span class="p">,</span> <span class="dl">'</span><span class="s1">stop</span><span class="dl">'</span><span class="p">]);</span>
      <span class="nx">workersFired</span><span class="o">++</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">workersFired</span> <span class="o">===</span> <span class="nx">numWorkers</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">setImmediate</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="c1">// See https://nodejs.org/api/timers.html#timers_setimmediate_callback_args</span>
          <span class="nx">broker</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">cluster</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">numWorkers</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cluster</span><span class="p">.</span><span class="nx">fork</span><span class="p">({</span><span class="na">identity</span><span class="p">:</span> <span class="dl">"</span><span class="s2">worker</span><span class="dl">"</span><span class="o">+</span><span class="nx">i</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">isMaster</span><span class="p">)</span> <span class="nx">main</span><span class="p">();</span>
<span class="k">else</span> <span class="nx">workerTask</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Observa que pese a que el worker env√≠a solamente <code class="language-plaintext highlighter-rouge">[ 'ready' ]</code>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="codehilite"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>  <span class="kd">const</span> <span class="nx">sendMessage</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">dealer</span><span class="p">.</span><span class="nx">send</span><span class="p">([</span><span class="dl">'</span><span class="s1">ready</span><span class="dl">'</span><span class="p">]);</span>
  <span class="p">...</span>
    <span class="c1">// Simulate some work</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">sendMessage</span><span class="p">,</span> <span class="nx">randomBetween</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>En el master recibimos como primer elemento la <strong>identity</strong> del worker:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="codehilite"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>  <span class="nx">broker</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// console.log("Inside Master. args = "+ins(args.map(x =&gt; x.toString())));</span>
    <span class="kd">const</span> <span class="nx">identity</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Consultemos la documentaci√≥n de 0MQ:</p>

<ul>
  <li>The ROUTER socket, unlike other sockets, tracks every connection
it has, and tells the caller about these.</li>
  <li>The way it tells the caller is to stick the connection <strong>identity</strong> in front of each message
received</li>
  <li>An <strong>identity</strong>, sometimes called an <strong>address</strong>, is just a binary
string with no meaning except <em>‚Äúthis is a unique handle to the
connection‚Äù</em></li>
  <li>Then, when you send a message via a ROUTER socket, you first send an identity frame.</li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">zmq_socket()</code> man page describes it thus:</p>

<blockquote>
  <p>When receiving messages a <code class="language-plaintext highlighter-rouge">ZMQ_ROUTER</code> socket shall prepend a message part containing the identity of the originating peer to the message before passing it to the application. Messages received are fair-queued from among all connected peers. 
When sending messages a <code class="language-plaintext highlighter-rouge">ZMQ_ROUTER</code> socket shall remove the first part of the message and use it to determine the identity of the peer the message shall be routed to.</p>
</blockquote>

<p>Cuando ejecuto este programa, obtengo una salida parecida a esta:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="codehilite"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>[~/.../microservices(master)]$ node dealer.js 
identity worker0 process 56820 port = 60300
identity worker2 process 56822 port = 60300
identity worker3 process 56823 port = 60300
identity worker1 process 56821 port = 60300
Completed: 24 tasks (worker3 56823)
Completed: 22 tasks (worker2 56822)
Completed: 19 tasks (worker1 56821)
Completed: 18 tasks (worker0 56820)
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Usando 0MQ y paralelismo de granja, compute en paralelo una aproximaci√≥n al n√∫mero œÄ aprovechando la siguiente f√≥rmula:</p>

\[\int_{0}^{1} \frac{4}{(1+x^2)} dx  = 4 \arctan(x) |_{0}^{1}\ = 4 ( \frac{\pi}{4} - 0) = \pi\]

<p>Para computar œÄ aproxime la integral mediante sumas de √°reas de rect√°ngulos:</p>

<p><img src="/tema2-async/practicas/p6-t2-microservices/integration-as-a-sum.png" alt="figure of the curve 1/1+x*x" /></p>

<ol>
  <li>El capataz divide el intervalo [0,1] en un n√∫mero de subintervalos bastante mayor que el n√∫mero de trabajadores</li>
  <li>El capataz  le indicar√° a cada trabajador para que intervalo debe calcular el  √°rea</li>
  <li>El trabajador computa el √°rea haciendo la correspondiente suma de Riemann y la devuelve al capataz,</li>
  <li>El capataz a√±ade dicha sub√°rea al acumulador de √°rea computada.</li>
  <li>El capataz env√≠a un nuevo intervalo al trabajador si quedan intervalos por computar. En caso contrario env√≠a un mensaje de parada.</li>
</ol>

<h2 id="reto-2-chat">Reto 2: Chat</h2>

<p>Escriba un chat de l√≠nea de comandos - con rooms - usando 0MQ.</p>

<ol>
  <li>Use el patr√≥n PUB/SUB.</li>
  <li>Use el ‚Äút√≥pico‚Äù del patr√≥n PUB/SUB para implantar las rooms
    <ol>
      <li>
        <p>En el servidor:</p>

        <div class="language-js highlighter-rouge"><div class="highlight"><pre class="codehilite"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>     <span class="nx">publisher</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span> <span class="p">[</span><span class="dl">"</span><span class="s2">room-1</span><span class="dl">"</span><span class="p">,</span> <span class="c1">// topic</span>
                        <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span>
                          <span class="p">{</span>
                            <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span>
                            <span class="na">from</span><span class="p">:</span> <span class="nx">user</span><span class="p">,</span>
                            <span class="na">content</span><span class="p">:</span> <span class="nx">content</span>
                          <span class="p">}</span>
                        <span class="p">)</span>
                      <span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div>        </div>
      </li>
      <li>
        <p>En el cliente:</p>

        <div class="language-js highlighter-rouge"><div class="highlight"><pre class="codehilite"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nx">subscriber</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">room</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
  <span class="kd">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>En el cliente, para la lectura desde teclado use <a href="https://nodejs.org/api/readline.html#readline_readline">readline</a>. Sigue un ejemplo:</li>
</ol>

<p>Fichero <strong>local/src/javascript/learning/readline-examples/small-cli.js</strong></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="codehilite"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre>  <span class="kd">const</span> <span class="nx">readline</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">readline</span><span class="dl">'</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">rl</span> <span class="o">=</span> <span class="nx">readline</span><span class="p">.</span><span class="nx">createInterface</span><span class="p">({</span>
    <span class="na">input</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">stdin</span><span class="p">,</span>
    <span class="na">output</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">,</span>
    <span class="na">prompt</span><span class="p">:</span> <span class="dl">'</span><span class="s1">DSI&gt; </span><span class="dl">'</span>
  <span class="p">});</span>

  <span class="kd">const</span> <span class="nx">bye</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Have a great day!</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">methods</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">hello</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">world</span><span class="dl">"</span><span class="p">),</span>
    <span class="na">exit</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">bye</span><span class="p">(),</span>
    <span class="na">default</span><span class="p">:</span> <span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Say what? I might have heard '</span><span class="p">${</span><span class="nx">line</span><span class="p">.</span><span class="nx">trim</span><span class="p">()}</span><span class="s2">'`</span><span class="p">),</span>
  <span class="p">};</span>

  <span class="nx">rl</span><span class="p">.</span><span class="nx">prompt</span><span class="p">();</span>

  <span class="nx">rl</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">line</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">choice</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">choice</span> <span class="k">in</span> <span class="nx">methods</span><span class="p">)</span> <span class="nx">methods</span><span class="p">[</span><span class="nx">choice</span><span class="p">]();</span>
    <span class="k">else</span> <span class="nx">methods</span><span class="p">[</span><span class="dl">'</span><span class="s1">default</span><span class="dl">'</span><span class="p">](</span><span class="nx">line</span><span class="p">);</span>
    <span class="nx">rl</span><span class="p">.</span><span class="nx">prompt</span><span class="p">();</span>
  <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">close</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">bye</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<ol>
  <li>El cliente env√≠a sus mensajes al servidor usando un socket 0MQ  REQ/REP.
El cliente env√≠a su mensaje al servidor como un request JSON indicando la <em>room</em> a la que va dirigida. 
El servidor, una vez recibe el mensaje en el socket REQ/REP, lo 
publica a los clientes conectados a la room especificada usando el socket PUB/SUB</li>
</ol>

<!--
* ZeroMQ is the answer: https://youtu.be/v6AGUeZOVSU
    * [ZeroMQ is the answer](https://youtu.be/v6AGUeZOVSU)
-->

<h2 id="references">References</h2>

<ul>
  <li><a href="https://zeromq.org/">https://zeromq.org/</a></li>
  <li><a href="/tema2-async/practicas/p6-t2-microservices/old-references">Old References</a></li>
</ul>









            </div>


                        
<h2>Comment with GitHub Utterances</h2>
            
<script src="https://utteranc.es/client.js"
        repo="ULL-MII-SYTWS/ull-mii-sytws.github.io"
        issue-term="pathname"
        label="SYTWS"
        theme="dark-blue"
        crossorigin="anonymous"
        async>
</script>
            



 
            <!-- Mathjax Support  -->
            <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


            
        </section>
    
    </div>


    
</body>

</html>
